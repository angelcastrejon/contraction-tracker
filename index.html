<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Contraction Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg:#0f1220;--card:#1a1f3c;--text:#fff;
  --accent:#6cf2c2;--warn:#ff6b6b;--muted:#aab;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.container{max-width:650px;margin:auto;padding:1rem}
.card{background:var(--card);border-radius:12px;padding:1rem;margin-bottom:1rem}
button{width:100%;padding:1rem;font-size:1.2rem;border-radius:12px;border:none;font-weight:bold}
.start{background:var(--accent);color:#000}
.stop{background:#ffd166;color:#000}
.reset{background:transparent;border:1px solid var(--warn);color:var(--warn)}
.timer{font-size:1.6rem;text-align:center;margin-top:.5rem}
.big{font-size:2rem;font-weight:bold}
.alert{color:var(--warn)} .ok{color:var(--accent)}
.footer{font-size:.75rem;color:var(--muted);text-align:center;margin-top:1rem}
input{width:100%;padding:.6rem;border-radius:8px;border:none;margin-top:.5rem}
svg{width:100%;height:160px}
</style>
</head>
<body>

<div class="container">
  <h2 style="text-align:center">Contraction Tracker</h2>

  <div class="card">
    <label>Session Label</label>
    <input id="sessionLabel" placeholder="e.g. Early labor">
  </div>

  <div class="card">
    <button id="btn" class="start" onclick="toggle()">‚ñ∂ Start Contraction</button>
    <div class="timer" id="timer">00:00</div>
  </div>

  <div class="card" id="status">Waiting for data‚Ä¶</div>

  <div class="card">
    <svg id="chart"></svg>
  </div>

  <div class="card">
    <button class="reset" onclick="resetData()">Reset Session</button>
  </div>

  <div class="footer">
    This tool is for informational purposes only and is not medical advice.<br>
    Always follow the guidance of your medical team.
  </div>
</div>

<script>
const KEY="contractions_v2";
let state=JSON.parse(localStorage.getItem(KEY)||"{}");
if(!state.data) state={session:"",data:[]};

let running=false,start=0,timerInt=null;

function save(){localStorage.setItem(KEY,JSON.stringify(state));}

function toggle(){
  if(!running){
    running=true;start=Date.now();
    btn.textContent="‚èπ Stop & Save";btn.className="stop";
    timerInt=setInterval(updateTimer,500);
  } else {
    running=false;clearInterval(timerInt);
    const dur=Math.round((Date.now()-start)/1000);
    add(dur);
    btn.textContent="‚ñ∂ Start Contraction";btn.className="start";
    timer.textContent="00:00";
  }
}

function updateTimer(){
  const s=Math.floor((Date.now()-start)/1000);
  timer.textContent=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
}

function add(dur){
  const now=new Date();
  state.session=document.getElementById("sessionLabel").value;
  state.data.push({
    t:now.getHours()*60+now.getMinutes()+now.getSeconds()/60,
    dur
  });
  save();render();
}

function resetData(){
  if(!confirm("Reset this session?"))return;
  state={session:"",data:[]};
  save();render();
}

function render(){
  updateStatus();
  drawChart();
}

function updateStatus(){
  if(state.data.length<3)return;
  const last=state.data.at(-1).t;
  const win=state.data.filter(d=>last-d.t<=60);
  if(win.length<3)return;

  const gaps=win.slice(1).map((d,i)=>d.t-win[i].t);
  const avgGap=avg(gaps),avgDur=avg(win.map(d=>d.dur));
  const perHr=win.length;
  const ema=EMA(gaps,0.4);

  const sustained = avgGap<=5 && avgDur>=60 && win.length>=6;
  const suggest = sustained ? "üìû Consider calling L&D" : "";

  status.innerHTML=`
    <div class="big ${sustained?'alert':'ok'}">
      ${sustained?'5-1-1 Sustained':'Not 5-1-1'}
    </div>
    Avg spacing: ${avgGap.toFixed(1)} min<br>
    Avg duration: ${avgDur.toFixed(0)} sec<br>
    Contractions/hr: ${perHr}<br>
    EMA spacing: ${ema.toFixed(1)} min<br>
    <strong>${suggest}</strong>
  `;
}

function drawChart(){
  const svg=document.getElementById("chart");
  svg.innerHTML="";
  if(state.data.length<2)return;

  const gaps=state.data.slice(1).map((d,i)=>d.t-state.data[i].t);
  const max=Math.max(...gaps,5);
  gaps.forEach((g,i)=>{
    const x=i*(100/gaps.length);
    const y=140-(g/max*120);
    svg.innerHTML+=`<circle cx="${x+10}%" cy="${y}" r="3" fill="#6cf2c2"/>`;
  });
  svg.innerHTML+=`<line x1="0" y1="${140-(5/max*120)}" x2="100%" y2="${140-(5/max*120)}" stroke="#ff6b6b" stroke-dasharray="4"/>`;
}

function avg(a){return a.reduce((s,v)=>s+v,0)/a.length;}
function EMA(arr,alpha){
  return arr.reduce((e,v)=>alpha*v+(1-alpha)*e,arr[0]);
}

render();
</script>
</body>
</html>
