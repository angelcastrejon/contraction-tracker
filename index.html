<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Contraction Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
:root {
  --bg:#0f1220; --card:#1a1f3c; --text:#fff;
  --accent:#6cf2c2; --warn:#ff6b6b; --active:#ffd166; --muted:#aab;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.container{max-width:720px;margin:auto;padding:1rem}
.card{background:var(--card);border-radius:12px;padding:1rem;margin-bottom:1rem}
h1{text-align:center;margin:.3rem 0}
button{border:none;border-radius:12px;font-weight:bold}
.primary-btn{width:100%;padding:1rem;font-size:1.2rem}
.start{background:var(--accent);color:#000}
.stop{background:var(--active);color:#000}
.reset{background:transparent;border:1px solid var(--warn);color:var(--warn);padding:.6rem}
.big{font-size:1.8rem;font-weight:bold;text-align:center}
.ok{color:var(--accent)} .alert{color:var(--warn)}
.timer{text-align:center;font-size:1.6rem}
.footer{font-size:.75rem;color:var(--muted);text-align:center;margin-top:1.5rem}
canvas{width:100%;height:220px}
.metric{font-size:.9rem;margin:.25rem 0}

/* Tabs */
.tabs{display:flex;margin-bottom:.5rem}
.tab{
  flex:1;
  padding:.7rem;
  text-align:center;
  background:#141838;
  color:var(--muted);
  border-radius:10px;
  margin-right:.3rem;
}
.tab:last-child{margin-right:0}
.tab.active{
  background:var(--card);
  color:var(--accent);
  font-weight:bold;
}

/* Raw log */
.log-entry{
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  padding:.4rem 0;
  border-bottom:1px solid #2a2f55;
}
.log-entry:last-child{border-bottom:none}
</style>
</head>
<body>

<div class="container">
<h1>Contraction Tracker</h1>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('log')">Log</div>
  <div class="tab" onclick="switchTab('trends')">Trends</div>
</div>

<!-- LOG TAB -->
<div id="logTab">
  <div class="card">
    <button id="timerBtn" class="primary-btn start" onclick="toggleTimer()">▶ Start Contraction</button>
    <div id="timer" class="timer">00:00</div>
  </div>

  <div class="card" id="status">Waiting for data…</div>

  <div class="card">
    <div id="rawLog"></div>
  </div>
</div>

<!-- TRENDS TAB -->
<div id="trendsTab" style="display:none">
  <div class="card">
    <canvas id="chart"></canvas>
  </div>

  <div class="card">
    <div id="metrics"></div>
    <button class="reset" onclick="resetData()">Reset All Data</button>
  </div>
</div>

<div class="footer">
  This tool is for informational purposes only and is not medical advice.<br>
  Always follow the guidance of your medical team.
</div>
</div>

<script>
/* ========= STORAGE ========= */
const STORAGE_KEY="contractions_v1";
let contractions=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(contractions))}

/* ========= TABS ========= */
function switchTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add("active");
  logTab.style.display=tab==="log"?"block":"none";
  trendsTab.style.display=tab==="trends"?"block":"none";
}

/* ========= TIMER ========= */
let running=false,startTime=null,interval=null;
function toggleTimer(){
  if(!running){
    running=true; startTime=Date.now();
    timerBtn.textContent="⏹ Stop & Save"; timerBtn.className="primary-btn stop";
    interval=setInterval(updateTimer,500);
  } else {
    running=false; clearInterval(interval);
    record(Math.round((Date.now()-startTime)/1000));
    timerBtn.textContent="▶ Start Contraction"; timerBtn.className="primary-btn start";
    timer.textContent="00:00";
  }
}
function updateTimer(){
  const e=Math.floor((Date.now()-startTime)/1000);
  timer.textContent=`${String(Math.floor(e/60)).padStart(2,"0")}:${String(e%60).padStart(2,"0")}`;
}

/* ========= DATA ========= */
function record(duration){
  const now=new Date();
  contractions.push({
    time: now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
    minutes: now.getHours()*60+now.getMinutes()+now.getSeconds()/60,
    duration
  });
  contractions.sort((a,b)=>a.minutes-b.minutes);
  save(); render();
}
function resetData(){
  if(!confirm("Erase all data on this device?")) return;
  contractions=[]; save(); render();
}

/* ========= SESSION INFERENCE ========= */
function inferSessions(data,gap=120){
  let s=[],c=[];
  data.forEach((d,i)=>{
    if(i===0){c=[d];return;}
    const g=d.minutes-data[i-1].minutes;
    if(g>=gap){s.push(c);c=[d]} else c.push(d);
  });
  if(c.length) s.push(c);
  return s;
}
function currentSession(){
  const s=inferSessions(contractions);
  return s.length?s[s.length-1]:[];
}

/* ========= METRICS ========= */
function avg(a){return a.reduce((s,v)=>s+v,0)/a.length}
function windowData(session,m){
  if(!session.length) return [];
  const last=session.at(-1).minutes;
  return session.filter(c=>last-c.minutes<=m);
}

/* ========= STATUS ========= */
function renderStatus(session){
  if(session.length<3){status.textContent="Gathering data…";return;}
  const w60=windowData(session,60);
  if(w60.length<3) return;

  const gaps=w60.slice(1).map((c,i)=>c.minutes-w60[i].minutes);
  const avgGap=avg(gaps), avgDur=avg(w60.map(c=>c.duration));
  const sustained=w60.length>=12 && avgGap<=5 && avgDur>=60;

  status.innerHTML=`
    <div class="big ${sustained?'alert':'ok'}">
      ${sustained?'5-1-1 sustained':'Not 5-1-1'}
    </div>
    Avg spacing (60m): ${avgGap.toFixed(1)} min<br>
    Avg duration (60m): ${avgDur.toFixed(0)} sec<br>
    ${sustained?'<b>Consider calling Labor & Delivery.</b>':''}
  `;
}

/* ========= RAW LOG (STACK STYLE) ========= */
function renderLog(){
  rawLog.innerHTML="";
  [...contractions].reverse().forEach(c=>{
    const d=document.createElement("div");
    d.className="log-entry";
    d.innerHTML=`<span>${c.time}</span><span>${c.duration}s</span>`;
    rawLog.appendChild(d);
  });
}

/* ========= CHART ========= */
function renderChart(session){
  const ctx=chart.getContext("2d");
  ctx.clearRect(0,0,chart.width,chart.height);
  if(session.length<2) return;

  const gaps=session.slice(1).map((c,i)=>c.minutes-session[i].minutes);
  const max=Math.max(...gaps,60);
  gaps.slice(-20).forEach((g,i)=>{
    const x=i*(chart.width/20);
    const y=chart.height-(g/max)*chart.height;
    ctx.fillStyle="#6cf2c2";
    ctx.fillRect(x,y,6,chart.height-y);
  });
}

/* ========= METRICS PANEL ========= */
function renderMetrics(session){
  if(!session.length){metrics.innerHTML="";return;}
  const w10=windowData(session,10),w30=windowData(session,30),w60=windowData(session,60);
  const spacing=w=>w.length>1?avg(w.slice(1).map((c,i)=>c.minutes-w[i].minutes)).toFixed(1):"–";

  metrics.innerHTML=`
    <div class="metric">Contractions/hr: ${w60.length}</div>
    <div class="metric">Avg spacing 10m: ${spacing(w10)} min</div>
    <div class="metric">Avg spacing 30m: ${spacing(w30)} min</div>
    <div class="metric">Avg spacing 60m: ${spacing(w60)} min</div>
    <div class="metric">Max duration (60m): ${Math.max(...w60.map(c=>c.duration))||0} sec</div>
  `;
}

/* ========= RENDER ========= */
function render(){
  const session=currentSession();
  renderStatus(session);
  renderLog();
  renderChart(session);
  renderMetrics(session);
}
render();
</script>
</body>
</html>
